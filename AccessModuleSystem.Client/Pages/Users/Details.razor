@page "/users/{id:Guid}"
@using AccessModuleSystem.Models.Enums
@using AccessModuleSystem.Contracts.User
@using AccessModuleSystem.Client.Extensions
@using System.Globalization

@inject HttpClient HttpClient

@attribute [Authorize]

<PageTitle>Детали пользователя</PageTitle>

@if (isLoading)
{
    <div class="d-flex justify-content-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Идет загрузка, пожалуйста, подождите...</span>
        </div>
    </div>
}
else
{
    if (userDetail is not null)
    {
        <h1>Детали пользователя №@userDetail.Id</h1>

        <hr />

        <div class="card card-tight mb-1 card-bottom-no-radius">
            <div class="card-header">
                <h4>Информация о пользователе</h4>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-2">Логин:</dt>
                    <dd class="col-sm-10">@userDetail.Username</dd>

                    <dt class="col-sm-2">Электронный адрес:</dt>
                    <dd class="col-sm-10">@userDetail.Email</dd>

                    <dt class="col-sm-2">Дата создания аккаунта:</dt>
                    <dd class="col-sm-10">@userDetail.CreatedAt</dd>

                    <dt class="col-sm-2">ФИО:</dt>
                    <dd class="col-sm-10">@string.Format($"{userDetail.Surname} {userDetail.Name} {userDetail.Patronymic}")</dd>

                    <dt class="col-sm-2">Роль в системе:</dt>
                    <dd class="col-sm-10">@userDetail.Role.GetDisplayName()</dd>

                    <dt class="col-sm-2">Блокировка:</dt>
                    <dd class="col-sm-10">@userDetail.IsBlocked</dd>
                </dl>
            </div>
        </div>
        
        @if (userDetail.Vehicle is not null)
        {
            <div class="card card-tight mb-1 card-top-no-radius">
                <div class="card-header">
                    <h4>Информация о транспортном средстве</h4>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-2">Имя владельца:</dt>
                        <dd class="col-sm-10">@userDetail.Vehicle.OwnerName</dd>

                        <dt class="col-sm-2">Номерной знак автомобиля:</dt>
                        <dd class="col-sm-10">@userDetail.Vehicle.LicensePlate</dd>

                        <dt class="col-sm-2">Статус разрешения:</dt>
                        <dd class="col-sm-10">@userDetail.Vehicle.Status.GetDisplayName()</dd>

                        <dt class="col-sm-2">Дата добавления:</dt>
                        <dd class="col-sm-10">@userDetail.Vehicle.CreatedAt.ToLongDateString()</dd>

                        <dt class="col-sm-2">Дата деактивации:</dt>
                        <dd class="col-sm-10">@userDetail.Vehicle.DeactivationAt?.ToLongDateString()</dd>
                    </dl>
                </div>
            </div>
        }
    }
    else
    {
        <div class="accessEvents justify-content-center align-content-center">
            <h3>@errorMessage</h3>
        </div>
    }

    <a href="/users" class="btn btn-primary mt-2">Назад</a>
}

@code {
    private bool isLoading = true;
    private string errorMessage = "Ошибка при загрузке. Попробуйте обновить страницу :(";

    [Parameter]
    public string id { get; set; } = string.Empty;
    private UserDetailDTO? userDetail;

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            if (Guid.TryParse(id, out var parsedId))
            {
                var response = await HttpClient.GetAsync($"api/users/{parsedId}");
                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<UserDetailDTO>();
                    if (result != null)
                    {
                        userDetail = result;
                    }
                    else
                    {
                        errorMessage = "Данные не найдены.";
                    }
                }
                else
                {
                    errorMessage = $"Ошибка загрузки данных: {response.ReasonPhrase}";
                }
            }
            else
            {
                errorMessage = "Неверный формат GUID.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Произошла ошибка: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
